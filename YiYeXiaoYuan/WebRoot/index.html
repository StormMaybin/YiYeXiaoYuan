<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>一页校园</title>
    <link href="css/bootstrap.min.css" rel="stylesheet"/>
    <link href="css/navbar.css" rel="stylesheet"/>
    <link href="css/pullToRefresh.css" rel="stylesheet"/>
    <link href="css/amazeui.min.css" rel="stylesheet"/>
    <script src="js/jquery-2.1.0.js"></script>
    <script src="js/iscroll.js"></script>
    <script src="js/pullToRefresh.js"></script>
    <script src="js/amazeui.min.js"></script>
    <script src="js/bootstrap.min.js"></script>

</head>
<body>
<div class="navigation1">
    <span class="glyphicon glyphicon-user" id="user1"></span>
</div>
<div id="goTop">
    <span class="glyphicon glyphicon-arrow-up"></span>
</div>
<div class="one-inner">
    <div id="wrapper">
        <ul id="dataUl" class="list-unstyled">
            <li>
                <div class="one-faqi" id="one-faqi">
                    <a href="newCar.html" role="button" class="btn btn-block">发起新的拼车</a>
                </div>
                <div class="one-datechoose">
                    <label class="one-choose" for="rili-date"><span
                            class="glyphicon glyphicon-chevron-right"></span> </label> <input
                        type="text" class="one-date" id="rili-date"
                         readonly/>
                </div>
                <div id="trueLove"></div>
            </li>
        </ul>


    </div>
    <div class="one-dialog" id="dialog-confirm">
        <div class="dialog-inner">
            <span>确定报名？</span>
        </div>
        <div class="dialog-btn btn-group">
            <a class="btn" role="button">是</a> <a class="btn" role="button">否</a>
        </div>
    </div>
    <!--弹窗 是否确认报名-->
    <div class="one-dialog" id="dialog-login">
        <p>请先登录您的账号</p>
        <p>正在跳转至登录界面</p>
        <img src="img/loading.gif"/>
    </div>
    <!--未登录弹窗-->
    <div class="one-dialog" id="dialog-success">
        <div class="dialog-inner">
            <span>报名成功。</span> <span>在我的行程查看拼车信息</span><br> <img
                src="img/loading.gif"/>
        </div>
    </div>
    <!--弹窗报名成功-->
    <div class="one-dialog" id="dialog-error">
        <div class="dialog-inner">
            <span>开始新的拼车前请取消已有拼车</span>
        </div>
    </div>
    <!--弹窗报名之前请取消已有报名-->
    <div class="one-dialog" id="dialog-error2">
        <div class="dialog-inner">
            <span>没有更多拼车数据了</span>
        </div>
    </div>
    <!--没有更多数据-->
    <div id="dialog-love">
        <span>取消</span> <span>进入</span>
    </div>
</div>
<script  src="js/1.js"></script>
<script>
    console.log('y');
    var $self;
    var carData1;//全局变量
    var j = 2;// load function
    var addperson = function (num, $this1) {
        for (var i = 0; i < num; i++) {
            $this1.find('.information-people>span:eq(' + i + ')').addClass(
                'glyphicon glyphicon-user');
        }
    };// 添加拼车总人数
    var addcolor = function (num, $this1) {
        for (var i = 0; i < num; i++) {
            $this1.find('.information-people>span:eq(' + i + ')').addClass(
                'add-color');
        }
    };//  添加加入人数

    var fresh_page = function () {
        $.ajax({
                method: 'post',
                url: 'servlet/PubTimeServlet',
                dataType: 'json',
                data:{
                  'pubTime':$('#rili-date').val()
                },
                async: false,
                success: function (data) {
                    var carData = data;
                    for (var i = 0; i < 2; i++) {
                        $('#dataUl')
                            .append(
                                '<li class="child"><div class="one-information"><div class="information-time"><span>时间:</span><span class="time-date startDate">'
                                + carData[i].startDate
                                + '</span><span class="time-time startTime">'
                                + carData[i].startTime_min_hour
                                + ':'
                                + carData[i].startTime_min_min
                                + '-'
                                + carData[i].startTime_max_hour
                                + ':'
                                + carData[i].startTime_max_min
                                + '</span></div><div class="information-where"><span>出发:<span class="where-start startPos">'
                                + carData[i].startPos
                                + '</span></span><span class="where-end">到达:</span><span class="where-finish arrivePos">'
                                + carData[i].arrivePos
                                + '</span></div><div class="information-people"><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class="people-number">上限<p class="maxMember" style="display: inline;">'
                                + carData[i].maxMember
                                + '</p>人，已有<p class="curtMember"  style="display: inline;">'
                                + carData[i].curtMember
                                + '</p>人</span></div><div class="information-remark"><span>备注:</span><span class="remark-content message">'
                                + carData[i].message
                                + '</span></div><div class="information-issue">发布于<span class="issue-date pubtime">'
                                + carData[i].pubTime
                                + '</span></div><div class="information-button"><button href="#" role=button class="issue-btn btn btn-block sign-btn" id="">报名</button></div></div></li>'
                            );
//                            console.log('1');
                        var m = i + 1;
                        $self = $('.list-unstyled li:eq(' + m + ')');
                        addperson(carData[i].maxMember, $self);
                        addcolor(carData[i].curtMember, $self);
                    }
                    carData1 = carData;
                    return true;
                },
//                error: function () {
////                        alert('net wrong');
//                    var carData = [{
//                        "message": "带回待会  ",
//                        "id": 17,
//                        "pubTime": "2016-11-25",
//                        "uid": 11,
//                        "curtMember": 5,
//                        "startTime_min_min": "29",
//                        "startDate": "2016-11-25",
//                        "startTime_max_min": "20",
//                        "startPos": "火车站",
//                        "startTime_min_hour": "14",
//                        "startTime_max_hour": "19",
//                        "maxMember": 6,
//                        "arrivePos": "西电南校区"
//                    }, {
//                        "message": "活生生",
//                        "id": 16,
//                        "pubTime": "2016-11-23",
//                        "uid": 11,
//                        "curtMember": 5,
//                        "startTime_min_min": "20",
//                        "startDate": "2016-11-23",
//                        "startTime_max_min": "50",
//                        "startPos": "西电",
//                        "startTime_min_hour": "14",
//                        "startTime_max_hour": "17",
//                        "maxMember": 6,
//                        "arrivePos": "火车站"
//                    }, {
//                        "message": "准时",
//                        "id": 12,
//                        "pubTime": "2016-11-21",
//                        "uid": 4,
//                        "curtMember": 2,
//                        "startTime_min_min": "00",
//                        "startDate": "2016-11-21",
//                        "startTime_max_min": "20",
//                        "startPos": "西电南校区",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "17",
//                        "maxMember": 5,
//                        "arrivePos": "航天城站"
//                    }, {
//                        "message": "妹子",
//                        "id": 13,
//                        "pubTime": "2016-11-21",
//                        "uid": 4,
//                        "curtMember": 1,
//                        "startTime_min_min": "10",
//                        "startDate": "2016-11-21",
//                        "startTime_max_min": "30",
//                        "startPos": "火车站",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "15",
//                        "maxMember": 4,
//                        "arrivePos": "航天城"
//                    }, {
//                        "message": ".。。。。----djegdgs。",
//                        "id": 14,
//                        "pubTime": "2016-11-21",
//                        "uid": 4,
//                        "curtMember": 2,
//                        "startTime_min_min": "10",
//                        "startDate": "2016-11-21",
//                        "startTime_max_min": "30",
//                        "startPos": "西电南校区",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "15",
//                        "maxMember": 5,
//                        "arrivePos": "航天城站"
//                    }, {
//                        "message": "要求：行李少。。",
//                        "id": 15,
//                        "pubTime": "2016-11-21",
//                        "uid": 11,
//                        "curtMember": 2,
//                        "startTime_min_min": "10",
//                        "startDate": "2016-11-21",
//                        "startTime_max_min": "30",
//                        "startPos": "咸阳机场",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "19",
//                        "maxMember": 5,
//                        "arrivePos": "西电南校区"
//                    }, {
//                        "message": "只要妹子哈哈哈 。。。。",
//                        "id": 10,
//                        "pubTime": "2016-11-15",
//                        "uid": 3,
//                        "curtMember": 4,
//                        "startTime_min_min": "30",
//                        "startDate": "2016-11-13",
//                        "startTime_max_min": "30",
//                        "startPos": "钟楼站",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "14",
//                        "maxMember": 5,
//                        "arrivePos": "西电南校区"
//                    }, {
//                        "message": "只要妹子哈哈哈 。。。。",
//                        "id": 11,
//                        "pubTime": "2016-11-15",
//                        "uid": 3,
//                        "curtMember": 4,
//                        "startTime_min_min": "30",
//                        "startDate": "2016-11-13",
//                        "startTime_max_min": "30",
//                        "startPos": "钟楼站",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "14",
//                        "maxMember": 5,
//                        "arrivePos": "火车站"
//                    }, {
//                        "message": "没什么要求，2333",
//                        "id": 5,
//                        "pubTime": "2016-11-13",
//                        "uid": 3,
//                        "curtMember": 1,
//                        "startTime_min_min": "30",
//                        "startDate": "2016-11-13",
//                        "startTime_max_min": "30",
//                        "startPos": "航天城地铁站",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "14",
//                        "maxMember": 6,
//                        "arrivePos": "西电北校区"
//                    }, {
//                        "message": "没什么要求，2333",
//                        "id": 6,
//                        "pubTime": "2016-11-13",
//                        "uid": 3,
//                        "curtMember": 1,
//                        "startTime_min_min": "30",
//                        "startDate": "2016-11-13",
//                        "startTime_max_min": "30",
//                        "startPos": "航天城地铁站",
//                        "startTime_min_hour": "13",
//                        "startTime_max_hour": "14",
//                        "maxMember": 6,
//                        "arrivePos": "西电北校区"
//                    }, {
//                        "message": "行李有点多",
//                        "id": 8,
//                        "pubTime": "2016-11-13",
//                        "uid": 3,
//                        "curtMember": 4,
//                        "startTime_min_min": "00",
//                        "startDate": "2016-11-13",
//                        "startTime_max_min": "00",
//                        "startPos": "西电北校区",
//                        "startTime_min_hour": "18",
//                        "startTime_max_hour": "19",
//                        "maxMember": 6,
//                        "arrivePos": "西电南校区"
//                    }, {
//                        "message": "我人很准时",
//                        "id": 2,
//                        "pubTime": "2016-11-09",
//                        "uid": 1,
//                        "curtMember": 3,
//                        "startTime_min_min": "20",
//                        "startDate": "2016-11-09",
//                        "startTime_max_min": "59",
//                        "startPos": "西电南校区",
//                        "startTime_min_hour": "18",
//                        "startTime_max_hour": "23",
//                        "maxMember": 6,
//                        "arrivePos": "火车站"
//                    }, {
//                        "message": "行李多",
//                        "id": 3,
//                        "pubTime": "2016-11-09",
//                        "uid": 1,
//                        "curtMember": 3,
//                        "startTime_min_min": "00",
//                        "startDate": "2016-11-09",
//                        "startTime_max_min": "59",
//                        "startPos": "西电南校区",
//                        "startTime_min_hour": "06",
//                        "startTime_max_hour": "23",
//                        "maxMember": 6,
//                        "arrivePos": "西电北校区"
//                    }, {
//                        "message": "我人很准时",
//                        "id": 1,
//                        "pubTime": "2016-11-08",
//                        "uid": 1,
//                        "curtMember": 3,
//                        "startTime_min_min": "00",
//                        "startDate": "2016-11-08",
//                        "startTime_max_min": "59",
//                        "startPos": "西电南校区",
//                        "startTime_min_hour": "22",
//                        "startTime_max_hour": "23",
//                        "maxMember": 6,
//                        "arrivePos": "火车站"
//                    }];
//                    for (var i = 0; i < 2; i++) {
//                        $('#dataUl')
//                            .append(
//                                '<li class="child"><div class="one-information"><div class="information-time"><span>时间:</span><span class="time-date startDate">'
//                                + carData[i].startDate
//                                + '</span><span class="time-time startTime">'
//                                + carData[i].startTime_min_hour
//                                + ':'
//                                + carData[i].startTime_min_min
//                                + '-'
//                                + carData[i].startTime_max_hour
//                                + ':'
//                                + carData[i].startTime_max_min
//                                + '</span></div><div class="information-where"><span>出发:<span class="where-start startPos">'
//                                + carData[i].startPos
//                                + '</span></span><span class="where-end">到达:</span><span class="where-finish arrivePos">'
//                                + carData[i].arrivePos
//                                + '</span></div><div class="information-people"><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class="people-number">上限<p class="maxMember" style="display: inline;">'
//                                + carData[i].maxMember
//                                + '</p>人，已有<p class="curtMember"  style="display: inline;">'
//                                + carData[i].curtMember
//                                + '</p>人</span></div><div class="information-remark"><span>备注:</span><span class="remark-content message">'
//                                + carData[i].message
//                                + '</span></div><div class="information-issue">发布于<span class="issue-date pubtime">'
//                                + carData[i].pubTime
//                                + '</span></div><div class="information-button"><button href="#" role=button class="issue-btn btn btn-block sign-btn" id="">报名<p  id="carId" hidden>' + carData[i].id + '</p></button></div></div></li>'
//                            );
////                            console.log('1');
//                        var m = i + 1;
//                        $self = $('.list-unstyled li:eq(' + m + ')');
////                        console.log($self.find('#carId').html());
//                        addperson(carData[i].maxMember, $self);
//                        addcolor(carData[i].curtMember, $self);
//                        carData1=carData;
//                    }
//                    console.log('刷新两个');
//                }
            error:function () {
                alert('net wrong');
            }

            });

    };//首次进入的刷新

    fresh_page();

    sessionStorage.setItem("timer", true);//真爱大巴引导判断

    $("#rili-date").change(function () {
        $('.list-unstyled').children('.child').remove();

        fresh_page();

        var $date = $('#rili-date').val();
        var $arr = ['2017-01-13', '2017-01-14', '2017-01-15',
            '2017-01-16'];
        var timer = sessionStorage.getItem('timer');
        for (var i = 0; i < $arr.length; ++i) {
            if (($arr[i] == $date) && (timer == "true")) {
                $('#dialog-love').fadeIn(300);
                sessionStorage.setItem("timer", false)
            }
        }
    });//选择日期刷新


    var ticker = 0;//计算完整循环复制次数
    var ticker2 = 0;//阻止重复刷新

    refresher.init({
        id: "wrapper",//<------------------------------------------------------------------------------------┐
        pullDownAction: Refresh,
        pullUpAction: Load

    });
    function Refresh() {
        setTimeout(
            function () { // <-- Simulate network congestion, remove setTimeout from production!
                //上拉刷新
                $.ajax({
                    type: 'post',
                    url: 'servlet/IndexServlet',
                    dataType: 'json',
                    success: function (data) {
                        //alert(data[1].message);
                        $('body').append("<script src='js/1.js'><\/script>");
                        var carData = data;
                        $('.list-unstyled').children('.child').remove();										//remove function!!!!
                        for (var i = 0; i < data.length; ++i) {
                            $('#dataUl')
                                .append(
                                    '<li class="child"><div class="one-information"><div class="information-time"><span>时间:</span><span class="time-date startDate">'
                                    + carData[i].startDate
                                    + '</span><span class="time-time startTime">'
                                    + carData[i].startTime_min_hour
                                    + ':'
                                    + carData[i].startTime_min_min
                                    + '-'
                                    + carData[i].startTime_max_hour
                                    + ':'
                                    + carData[i].startTime_max_min
                                    + '</span></div><div class="information-where"><span>出发:<span class="where-start startPos">'
                                    + carData[i].startPos
                                    + '</span></span><span class="where-end">到达:</span><span class="where-finish arrivePos">'
                                    + carData[i].arrivePos
                                    + '</span></div><div class="information-people"><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class="people-number">上限<p class="maxMember" style="display: inline;">'
                                    + carData[i].maxMember
                                    + '</p>人，已有<p class="curtMember"  style="display: inline;">'
                                    + carData[i].curtMember
                                    + '</p>人</span></div><div class="information-remark"><span>备注:</span><span class="remark-content message">'
                                    + carData[i].message
                                    + '</span></div><div class="information-issue">发布于<span class="issue-date pubtime">'
                                    + carData[i].pubTime
                                    + '</span></div><div class="information-button"><button href="#" role=button class="issue-btn btn btn-block sign-btn" id="">报名<p  id="carId" hidden>' + carData[i].id + '</p></button></div></div></li>'
                                );
                            var m = i + 1;
                            $self = $('.list-unstyled li:eq(' + m + ')');
                            addperson(carData[i].maxMember, $self);
                            addcolor(carData[i].curtMember, $self);
                        }
                        return j = 2;//重置data的下标
                    },
                    error: function () {
                        console.log('net wrong');
                    }
                });
                wrapper.refresh();
                /****remember to refresh after  action completed！ ---yourId.refresh(); ----| ****/
            }, 1000);

    }//刷新函数

    function Load() {
        setTimeout(function () {// <-- Simulate network congestion, remove setTimeout from production!
            //上拉加载更多数据
            //函数写这
//            alert(carData1.length);
            var length = carData1.length - 3;
            for (var i = 0; i <= 9; i++) {
                if (ticker * 10 + i > length || ticker2 == 1) {
                    //没有更多数据
                    $('#dialog-error2').fadeIn(300);
                    setTimeout(function () {
                        $('#dialog-error2').fadeOut(300);
                    }, 2000);
                    ticker2 = 1;
                    wrapper.refresh();
                    return false;
                } else {
                    $('#dataUl')
                        .append(
                            '<li class="child"><div class="one-information"><div class="information-time"><span>时间:</span><span class="time-date startDate">'
                            + carData1[j].startDate
                            + '</span><span class="time-time startTime">'
                            + carData1[j].startTime_min_hour
                            + ':'
                            + carData1[j].startTime_min_min
                            + '-'
                            + carData1[j].startTime_max_hour
                            + ':'
                            + carData1[j].startTime_max_min
                            + '</span></div><div class="information-where"><span>出发:<span class="where-start startPos">'
                            + carData1[j].startPos
                            + '</span></span><span class="where-end">到达:</span><span class="where-finish arrivePos">'
                            + carData1[j].arrivePos
                            + '</span></div><div class="information-people"><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class=""></span><span class="people-number">上限<p class="maxMember" style="display: inline;">'
                            + carData1[j].maxMember
                            + '</p>人，已有<p class="curtMember"  style="display: inline;">'
                            + carData1[j].curtMember
                            + '</p>人</span></div><div class="information-remark"><span>备注:</span><span class="remark-content message">'
                            + carData1[j].message
                            + '</span></div><div class="information-issue">发布于<span class="issue-date pubtime">'
                            + carData1[j].pubTime
                            + '</span></div><div class="information-button"><button href="#" role=button class="issue-btn btn btn-block sign-btn" id="">报名<p  id="carId" hidden>' + carData1[j].id + '</p></button></div></div></li>'
                        );
                    var m = j + 1;
                    $self = $('.list-unstyled li:eq(' + m + ')');
                    addperson(carData1[j].maxMember, $self);
                    addcolor(carData1[j].curtMember, $self);
                    j += 1;
                }
            }
            ticker += 1;
            wrapper.refresh();
            /****remember to refresh after action completed！！！   ---id.refresh(); --- ****/

        }, 0);

    }//加载函数
</script>

</body>
</html>